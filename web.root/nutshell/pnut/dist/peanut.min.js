var Peanut;!function(e){e.allMessagesType=-1,e.infoMessageType=0,e.errorMessageType=1,e.warningMessageType=2,e.serviceResultSuccess=0,e.serviceResultPending=1,e.serviceResultWarnings=2,e.serviceResultErrors=3,e.serviceResultServiceFailure=4,e.serviceResultServiceNotAvailable=5;var t=function(){function t(){var t=this;this.loadViewModel=function(n,o){e.PeanutLoader.checkConfig();var s=n.split("/"),a="@app";"@"===n.substr(0,1)&&(a=s.shift());var r=(n=s.pop())+"ViewModel",i=a+"/"+s.join("/")+"/vm/"+r,c=t.parseFileName(i,e.Config.values.mvvmPath),u=c.root+c.name+".js",p=c.namespace;e.PeanutLoader.loadScript(u,function(){"verbose"==e.Config.values.loggingMode&&console.log("Loading "+p+"."+r);var t=new window[p][r];t.setVmName(n),o(t)})},this.getComponentPrototype=function(e){return window[e.namespace]&&window[e.namespace][e.className]?window[e.namespace][e.className]:null},this.loadComponentTemplate=function(t,n){e.PeanutLoader.getConfig(function(e){var o=t.root+"templates/"+t.templateFile;jQuery.get(o,function(e){0===e.toLowerCase().indexOf("<!doctype")&&(console.error("Template not found at "+o),e=""),n&&n(e)})})},this.loadComponentPrototype=function(t,n){if(window[t.namespace]&&window[t.namespace][t.className])n(window[t.namespace][t.className]);else{var o=t.root+"components/"+t.className+".js";e.PeanutLoader.load(o,function(){var e=window[t.namespace][t.className];n&&n(e)})}},this.loadAndRegisterComponentPrototype=function(e,n){var o=t.parseComponentName(e);t.loadComponentTemplate(o,function(e){t.loadComponentPrototype(o,function(t){ko.components.register(o.componentName,{viewModel:t,template:e}),n&&n(o)})})},this.registerComponentPrototype=function(e,n){var o=t.parseComponentName(e);t.loadComponentTemplate(o,function(e){var s=t.getComponentPrototype(o);ko.components.register(o.componentName,{viewModel:s,template:e}),n&&n(o)})},this.registerComponentInstance=function(e,n,o){var s=t.parseComponentName(e);t.loadComponentTemplate(s,function(e){t.getViewModelInstance(s,n,function(t){ko.components.register(s.componentName,{viewModel:{instance:t},template:e}),o&&o(s,t)})})},this.registerAndBindComponentInstance=function(e,n,o){t.registerComponentInstance(e,n,function(e,n){t.bindSection(e.componentName+"-container",n),o&&o()})},this.registerComponents=function(e,n){var o=e.shift();o?t.loadAndRegisterComponentPrototype(o,function(){t.registerComponents(e,n)}):n()},this.loadComponentPrototypes=function(n,o){var s=t,a=n.shift();if(a){var r=t.parseComponentName(a),i=r.root+"components/"+r.className+".js";e.PeanutLoader.load(i,function(){s.loadComponentPrototypes(n,o)})}else o()},this.bindNode=function(e,n){var o=t.getContainerNode(e);null!==o&&ko.applyBindingsToNode(o,null,n)},this.bindSection=function(n,o){var s=t.getContainerNode(n);null!==s&&("verbose"==e.Config.values.loggingMode&&console.log("bind section: "+n),ko.applyBindings(o,s),jQuery("#"+n).show())}}return t.prototype.toCamelCase=function(e,t,n){void 0===t&&(t="-"),void 0===n&&(n="pascal");for(var o=e.split(t),s="camel"==n?o.shift():"",a=0,r=o;a<r.length;a++){var i=r[a],c=i.substr(0,1);s=s+(c=c.toUpperCase())+i.substr(1)}return s},t.prototype.parseFileName=function(t,n){void 0===n&&(n=null),n=n||e.Config.values.commonRootPath;var o={root:"",name:"",namespace:"Peanut"},s=t.split("/");if(1==s.length)o.root=n,o.name=t;else if(""==s[0])o.name=s.pop(),o.root=s.join("/")+"/";else{var a=n;switch(s[0]){case"@pnut":a=e.Config.values.peanutRootPath,s.shift();break;case"@core":a=e.Config.values.corePath,s.shift();break;case"@app":o.namespace=e.Config.values.vmNamespace,a=e.Config.values.mvvmPath,s.shift();break;case"@pkg":s.shift();var r=s.shift();o.namespace=this.toCamelCase(r),a=e.Config.values.packagePath+r+"/";break;default:a=n}o.name=s.pop(),o.root=0==s.length?a:a+s.join("/")+"/"}return o},t.prototype.nameToFileName=function(e){var t=e.split("-"),n=t[0];return t.length>1&&(n+=t[1].charAt(0).toUpperCase()+t[1].substring(1)),n},t.prototype.parseComponentName=function(t){var n=this;if(!e.Config.loaded)throw"Peanut Config was not loaded.";"@"!==t.substr(0,1)&&(t="@app/"+t);var o=n.parseFileName(t,e.Config.values.mvvmPath),s=n.nameToFileName(o.name);return{root:o.root,className:s+"Component",templateFile:s+".html",componentName:o.name,namespace:o.namespace}},t.prototype.expandFileName=function(e,t){if(void 0===t&&(t=null),!e)return"";if("/"===e.substr(0,1)||"http"===e.toLowerCase().substr(0,4))return e;var n=this.parseFileName(e,t),o=e.substr(e.lastIndexOf(".")+1);if(o)switch(o.toLowerCase()){case"css":return n.root+"css/"+n.name;case"js":return n.root+"components/"+n.name}return e},t.prototype.loadResources=function(t,n){var o=this;e.PeanutLoader.checkConfig(),e.PeanutLoader.getConfig(function(s){for(var a=[],r=0;r<t.length;r++){var i=o.getLibrary(t[r],s);!1===i&&(i=o.expandFileName(t[r],s.mvvmPath)),"preloaded"!==i&&a.push(i)}e.PeanutLoader.load(a,n)})},t.prototype.getLibrary=function(e,t){var n=e.substr(0,5);if("@pkg:"==n){var o="js",s=e.lastIndexOf(".");-1==s?e+=".js":o=e.substr(s+1);var a=e.substr(5).split("/"),r=a.shift();return t.packagePath+r+"/"+o+"/"+a.join("/")}if("@lib:"==n){var i=e.substr(5);if(i in t.libraries)return t.libraries[i];console.log('Library "'+i+'" not in settings.ini. Will look in application/mvvm. If the library is preloaded, add the entry "'+i+'=preinstalled" to the "[libraries]" section"')}return!1},t.prototype.getHtmlTemplate=function(t,n){var o=this;e.PeanutLoader.checkConfig();var s=o.parseFileName(t,e.Config.values.mvvmPath),a=s.name.split("-"),r=a[0]+a[1].charAt(0).toUpperCase()+a[1].substring(1),i=s.root+"templates/"+r+".html";e.PeanutLoader.loadHtml(i,n)},t.prototype.getViewModelInstance=function(e,t,n){t instanceof Function?t(n):n(t)},t.prototype.getContainerNode=function(e){var t=document.getElementById(e);return null==t&&(e?console.warn("Error: Container element '"+e+"' for section binding not found."):console.warn("Error: no container name for section binding.")),t},t}();e.KnockoutHelper=t;var n=function(){function t(){}return t.addTemplate=function(e,n){e=e.split("/").pop(),t.templates[e]=n},t.setWaiterType=function(e){return t.waiterType=e,t.waitDialog=jQuery(t.templates[e])},t.setMessage=function(e){t.waitDialog&&t.waitDialog.find("#wait-message").text(e)},t.setProgress=function(e,n){if(void 0===n&&(n=!1),"progress-waiter"==t.waiterType){var o=t.waitDialog.find("#wait-progress-bar"),s=e+"%";o.css("width",s),n&&o.text(s)}},t.show=function(n,o){if(void 0===n&&(n="Please wait ..."),void 0===o&&(o="spin-waiter"),t.visible)t.setMessage(n);else{var s=t.setWaiterType(o);e.ui.helper.showMessage(n,"wait-message",s),t.visible=!0}},t.hide=function(){t.visible&&t.waitDialog&&(e.ui.helper.hideMessage(t.waitDialog),t.visible=!1)},t.waitDialog=null,t.waiterType="spin-waiter",t.templates=Array(),t.visible=!1,t}();e.WaitMessage=n;var o=function(){return function(){}}();e.mailBox=o;var s=function(){function o(){var s=this;this.startVM=function(n,o){s.koHelper=new t,e.PeanutLoader.getConfig(function(e){s.koHelper.loadViewModel(n,function(e){e.start(s,function(){o&&o(e)})})})},this.loadResources=function(e,t){e instanceof Array?e.join(","):e=e.split(",");e.length;s.koHelper.loadResources(e,function(){t&&t()})},this.getHtmlTemplate=function(e,t){s.koHelper.getHtmlTemplate(e,t)},this.loadWaitMessageTemplate=function(t,o){var a=e.Config.values.uiExtension;t="@pnut/extensions/"+a+"/"+t,s.koHelper.getHtmlTemplate(t,function(e){n.addTemplate(t,e),o()})},this.bindNode=function(e,t){s.koHelper.bindNode(e,t)},this.bindSection=function(e,t){s.koHelper.bindSection(e,t)},this.registerComponents=function(e,t){var n=e;e instanceof Array?n=e.join(","):e=e.split(",");var a=e.length;s.koHelper.registerComponents(e,function(){o.LogMessage("Registered "+a+" components: "+n),t()})},this.registerComponentPrototype=function(e,t){s.koHelper.loadAndRegisterComponentPrototype(e,function(){o.LogMessage("Registered component prototype: "+e),t&&t()})},this.loadComponents=function(e,t){var n=e;e instanceof Array?n=e.join(", "):e=e.split(","),s.koHelper.loadComponentPrototypes(e,function(){o.LogMessage("Registered component prototypes: "+n),t&&t()})},this.registerComponent=function(e,t,n){t?s.koHelper.registerComponentInstance(e,t,function(){o.LogMessage("Registered instance of component: "+e),n()}):s.registerComponentPrototype(e,n)},this.attachComponent=function(e,t,n){t?s.koHelper.registerAndBindComponentInstance(e,t,function(){o.LogMessage("Attached component: "+e),n&&n()}):console.error("attachComponent: No component instance. Use ViewModelBase.attachComponent for component prototypes.")}}return o.prototype.initialize=function(n){var o=this;e.PeanutLoader.checkConfig(),o.koHelper=new t,e.PeanutLoader.loadUiHelper(function(){var t=e.ui.helper.getResourceList();o.loadResources(t,function(){o.attachComponent("@pnut/service-messages",a.instance,function(){o.loadWaitMessageTemplate("spin-waiter",function(){o.loadWaitMessageTemplate("progress-waiter",function(){o.loadWaitMessageTemplate("banner-waiter",function(){n&&n()})})})})})})},o.prototype.showWaiter=function(e){void 0===e&&(e="Please wait . . ."),n.show(e)},o.prototype.hideWaiter=function(){n.hide()},o.prototype.showBannerWaiter=function(e){void 0===e&&(e="Please wait . . ."),n.show(e,"banner-waiter")},o.prototype.showProgress=function(e){void 0===e&&(e="Please wait . . ."),n.show(e,"progress-waiter")},o.prototype.setProgress=function(e){n.setProgress(e)},o.prototype.showServiceMessages=function(e){a.instance.setServiceMessages(e)},o.prototype.hideServiceMessages=function(){a.instance.clearMessages()},o.prototype.showError=function(t){t?a.instance.addMessage(t,e.errorMessageType):a.instance.clearMessages(e.errorMessageType)},o.prototype.showMessage=function(t){t?a.instance.addMessage(t,e.infoMessageType):a.instance.clearMessages(e.infoMessageType)},o.prototype.showWarning=function(t){t?a.instance.addMessage(t,e.warningMessageType):a.instance.clearMessages(e.warningMessageType)},o.prototype.setErrorMessage=function(t){t?a.instance.setMessage(t,e.errorMessageType):a.instance.clearMessages(e.errorMessageType)},o.prototype.setInfoMessage=function(t){t?a.instance.setMessage(t,e.infoMessageType):a.instance.clearMessages(e.infoMessageType)},o.prototype.setWarningMessage=function(t){t?a.instance.setMessage(t,e.warningMessageType):a.instance.clearMessages(e.infoMessageType)},o.LogMessage=function(t){"verbose"===e.Config.values.loggingMode&&console.log(t)},o}();e.Application=s;var a=function(){function t(){var n=this;this.errorMessages=ko.observableArray([]),this.infoMessages=ko.observableArray([]),this.warningMessages=ko.observableArray([]),this.addMessage=function(o,s){switch(s){case e.errorMessageType:n.errorMessages.push({type:t.errorClass,text:o});break;case e.warningMessageType:n.warningMessages.push({type:t.warningClass,text:o});break;default:n.infoMessages.push({type:t.infoClass,text:o})}},this.setMessage=function(o,s){switch(s){case e.errorMessageType:n.errorMessages([{type:t.errorClass,text:o}]);break;case e.warningMessageType:n.warningMessages([{type:t.warningClass,text:o}]);break;default:n.infoMessages([{type:t.infoClass,text:o}])}},this.clearMessages=function(t){void 0===t&&(t=e.allMessagesType),t!=e.errorMessageType&&t!=e.allMessagesType||n.errorMessages([]),t!=e.warningMessageType&&t!=e.allMessagesType||n.warningMessages([]),t!=e.infoMessageType&&t!=e.allMessagesType||n.infoMessages([])},this.clearInfoMessages=function(){n.infoMessages([])},this.clearErrorMessages=function(){n.errorMessages([])},this.clearWarningMessages=function(){n.warningMessages([])},this.setServiceMessages=function(o){for(var s=o.length,a=[],r=[],i=[],c=0;c<s;c++){var u=o[c];switch(u.MessageType){case e.errorMessageType:a.push({type:t.errorClass,text:u.Text});break;case e.warningMessageType:r.push({type:t.warningClass,text:u.Text});break;default:i.push({type:t.infoClass,text:u.Text})}}n.errorMessages(a),n.warningMessages(r),n.infoMessages(i)}}return t.instance=new t,t.errorClass="service-message-error",t.infoClass="service-message-information",t.warningClass="service-message-warning",t}(),r=function(){function t(t){var n=this;this.clientApp=t,this.securityToken="",this.errorInfo="",this.errorMessage="",this.setSecurityToken=function(e){n.securityToken=e},this.hideServiceMessages=function(){n.clientApp.hideServiceMessages()},this.showServiceMessages=function(e){n.clientApp.showServiceMessages(e.Messages)},this.handleServiceResponse=function(e){return n.showServiceMessages(e),!0},this.showExceptionMessage=function(e){var t=n.parseErrorResult(e);return n.clientApp.showError(t),t},this.executeRPC=function(t,o,s,a,r){if(void 0===s&&(s=""),!e.Config.loaded)throw"Peanut.config must be initialized before ajax call.";var i=e.Config.values.serviceUrl,c=n;c.errorMessage="",c.errorInfo="",s=s?JSON.stringify(s):"";var u={serviceCode:o,topsSecurityToken:c.securityToken,request:s};return jQuery.ajax({type:t,data:u,dataType:"json",cache:!1,url:i}).done(function(e){c.showServiceMessages(e),a&&a(e)}).fail(function(e,t){c.errorMessage=c.showExceptionMessage(e),c.errorInfo=e?e.responseText:"",r&&r({message:c.errorMessage,details:c.errorInfo})})},this.executeService=function(e,t,o,s){return void 0===t&&(t=""),n.executeRPC("POST",e,t,o,s)},this.getFromService=function(e,t,o,s){return void 0===t&&(t=""),n.executeRPC("POST",e,t,o,s)},this.getErrorInformation=function(){return n.errorInfo};var o=this;o.securityToken=o.readSecurityToken()}return t.create=function(e){return new t(e)},t.getInstance=function(e){return null==t.instance&&(t.instance=new t(e)),t.instance},t.prototype.readSecurityToken=function(){var e=document.cookie;if(e){var t=e.match(new RegExp("peanutSecurity=([^;]+)"));if(t)return t[1]}return""},t.prototype.parseErrorResult=function(e){var t="An unexpected system error occurred.";try{if(e.status){if("404"==e.status)return t+" The web service was not found.";t=t+" Status: "+e.status,e.statusText&&(t=t+" "+e.statusText)}}catch(e){t=t+" Error handling failed: "+e.toString}return t},t.prototype.getInfoMessages=function(t){for(var n=[],o=0,s=0;s<t.length;s++){var a=t[s];a.MessageType==e.infoMessageType&&(n[o++]=a.Text)}return n},t.prototype.getNonErrorMessages=function(t){for(var n=[],o=0,s=0;s<t.length;s++){var a=t[s];a.MessageType!=e.errorMessageType&&(n[o++]=a.Text)}return n},t.prototype.getErrorMessages=function(t){for(var n=[],o=0,s=0;s<t.length;s++){var a=t[s];a.MessageType==e.errorMessageType&&(n[o++]=a.Text)}return n},t.prototype.getMessagesText=function(e){for(var t=[],n=0,o=0;o<e.length;o++){var s=e[o];t[n++]=s.Text}return t},t.prototype.getSecurityToken=function(t){var n={serviceCode:"getxsstoken"};if(!e.Config.loaded)throw"Peanut.config must be initialized before ajax call.";return jQuery.ajax({type:"POST",data:n,dataType:"json",cache:!1,url:e.Config.values.serviceUrl}).done(t)},t.instance=null,t}();e.ServiceBroker=r;var i=function(){return function(e){this.Messages=[],this.Result=0;var t=this;t.Value=e,t.Data=e}}();e.fakeServiceResponse=i;var c=function(){function t(){var t=this;this.translations=[],this.start=function(e,n){var o=t;o.language=o.getUserLanguage(),o.addTranslations(u.GetKvArray("peanutTranslations")),o.application=e,o.services=r.getInstance(e),o.application.registerComponents("@pnut/translate",function(){o.init(function(){n(o)})})},this.vmName=null,this.language="en-us",this.setVmName=function(e){t.vmName=e},this.getVmName=function(){return t.vmName},this.getSectionName=function(){return t.getVmName().toLowerCase()+"-view-container"},this.showDefaultSection=function(){var e=t.getSectionName();jQuery("#"+e).show()},this.bindDefaultSection=function(){var e=t.getSectionName();t.application.bindSection(e,t)},this.attachComponent=function(e,n){t.application.registerComponentPrototype(e,function(){n||(n=e.split("/").pop()+"-container"),t.application.bindSection(n,t)})},this.showLoadWaiter=function(){var e=t,n=e.translate("wait-action-loading")+", "+e.translate("wait-please")+"...";e.application.showBannerWaiter(n)},this.getActionMessage=function(e,n){return t.translate("wait-action-"+e)+" "+t.translate(n)+", "+t.translate("wait-please")+"..."},this.showActionWaiter=function(n,o,s){void 0===s&&(s="spin-waiter");var a=t.getActionMessage(n,o);e.WaitMessage.show(a,s)},this.showActionWaiterBanner=function(e,n){t.showActionWaiter(e,n,"banner-waiter")},this.getRequestVar=function(e,t){return void 0===t&&(t=null),p.Get(e,t)},this.translate=function(e,n){void 0===n&&(n=null);var o=t;return e in o.translations?o.translations[e]:null===n?e:n},this.addTranslation=function(e,n){t.translations[e]=n},this.addTranslations=function(e){var n=t;if(e)for(var o in e)n.translations[o]=e[o]},this.setLanguage=function(e){t.language=e},this.getLanguage=function(){return t.language},this.getVmInstance=function(){return t}}return t.prototype.getUserLanguage=function(){var e=navigator.language||navigator.userLanguage;return e?e.toLowerCase():"en-us"},t.prototype.getDefaultLoadMessage=function(){return this.translate("wait-loading","...")},t}();e.ViewModelBase=c;var u=function(){function e(){}return e.cleanCookieString=function(e){for(var t,n,o=e,s=/(%[^%]{2})/,a=[];null!=(a=s.exec(o))&&a.length>1&&""!=a[1];)t=parseInt(a[1].substr(1),16),n=String.fromCharCode(t),o=o.replace(a[1],n);return o},e.kvObjectsToArray=function(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],s=o.Value.split("+").join(" ");t[o.Key]=s.replace("[plus]","+")}return t},e.kvCookieToArray=function(t){var n=e.cleanCookieString(t),o=JSON.parse(n);return e.kvObjectsToArray(o)},e.Get=function(e,t){void 0===t&&(t=1);var n=document.cookie;if(n){var o=n.match(new RegExp(e+"=([^;]+)"));if(o&&o.length>t)return o[t]}return""},e.GetKvArray=function(t,n){void 0===n&&(n=1);var o=e.Get(t,n);return o?e.kvCookieToArray(o):[]},e}();e.Cookies=u;var p=function(){function e(){this.requestvars=[];for(var e=this,t=window.location.search,n=t.slice(t.indexOf("?")+1).split("&"),o=0;o<n.length;o++){var s=n[o].split("="),a=s[0];e.requestvars.push(a),e.requestvars[a]=s[1]}}return e.prototype.getValue=function(e){var t=this.requestvars[e];return t||null},e.Get=function(t,n){void 0===n&&(n=null),e.instance||(e.instance=new e);var o=e.instance.getValue(t);return null===o?n:o},e}();e.HttpRequestVars=p}(Peanut||(Peanut={}));